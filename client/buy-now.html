<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy Now - Kisaan Connect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header {
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            transform: translateY(-1px);
        }

        .product-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .product-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .price-section {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .quantity-btn {
            background: #2c5530;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: #4a7c59;
            transform: scale(1.1);
        }

        .quantity-input {
            width: 80px;
            text-align: center;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.5rem;
            font-weight: bold;
        }

        .checkout-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        .place-order-btn {
            background: linear-gradient(135deg, #ff9f00, #fb641b);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .place-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 159, 0, 0.3);
        }

        .feature-badge {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0.2rem;
            display: inline-block;
        }

        .address-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .address-card:hover {
            border-color: #2c5530;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .address-card.selected {
            border-color: #2c5530;
            background: rgba(44, 85, 48, 0.05);
        }

        .add-address-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .add-address-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3);
        }

        .loading-spinner {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .success-message {
            background: #00b894;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="/marketplace" class="back-btn me-3">
                        <i class="fas fa-arrow-left me-2"></i>Back to Marketplace
                    </a>
                    <h2 class="mb-0">Buy Now</h2>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <a href="/marketplace" class="text-white text-decoration-none">
                        <i class="fas fa-heart me-1"></i>
                        <span id="wishlist-count">0</span>
                    </a>
                    <a href="#" onclick="viewOrders()" class="text-white text-decoration-none">
                        <i class="fas fa-box me-1"></i>My Orders
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid px-4 mt-4">
        <div class="row justify-content-center">
            <!-- Product Details -->
            <div class="col-xl-5 col-lg-6 col-md-12 mb-4">
                <div class="product-card">
                    <div id="product-loading" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="product-content" style="display: none;">
                        <img id="product-image" src="" alt="Product" class="product-image">
                        <div class="p-4">
                            <h3 id="product-name" class="mb-3"></h3>
                            <p id="product-description" class="text-muted"></p>
                            
                            <div class="price-section">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="mb-1">₹<span id="product-price"></span>/kg</h4>
                                        <small>Inclusive of all taxes</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="badge bg-light text-dark">
                                            <i class="fas fa-star text-warning"></i>
                                            <span id="product-rating">4.5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="quantity-controls">
                                <span class="fw-bold">Quantity:</span>
                                <button type="button" class="quantity-btn" onclick="updateQuantity(-1)">-</button>
                                <input type="number" id="quantity" class="quantity-input" value="1" min="1" onchange="calculateTotal()">
                                <button type="button" class="quantity-btn" onclick="updateQuantity(1)">+</button>
                                <span class="ms-2 text-muted">kg</span>
                            </div>

                            <div id="product-features" class="mt-3">
                                <!-- Features will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Section -->
            <div class="col-xl-5 col-lg-6 col-md-12 mb-4">
                <div class="checkout-section">
                    <h4 class="mb-4">
                        <i class="fas fa-shopping-cart me-2"></i>Order Summary
                    </h4>

                    <!-- Order Summary -->
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Price per kg:</span>
                            <span>₹<span id="summary-price">0</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Quantity:</span>
                            <span><span id="summary-quantity">1</span> kg</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>₹<span id="summary-subtotal">0</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery Charges:</span>
                            <span class="text-success">FREE</span>
                        </div>
                        <div class="d-flex justify-content-between fw-bold h5">
                            <span>Total Amount:</span>
                            <span>₹<span id="summary-total">0</span></span>
                        </div>
                    </div>

                    <!-- Delivery Address -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Delivery Address</h5>
                            <button type="button" class="add-address-btn btn-sm" onclick="showAddAddressModal()">
                                <i class="fas fa-plus me-1"></i>Add New
                            </button>
                        </div>
                        
                        <div id="addresses-loading" class="loading-spinner">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading addresses...</span>
                            </div>
                        </div>
                        
                        <div id="addresses-container">
                            <!-- Addresses will be populated here -->
                        </div>
                    </div>

                    <!-- Error/Success Messages -->
                    <div id="error-message" class="error-message"></div>
                    <div id="success-message" class="success-message"></div>

                    <!-- Place Order Button -->
                    <button type="button" id="place-order-btn" class="place-order-btn" onclick="placeOrder()" disabled>
                        <i class="fas fa-shopping-cart me-2"></i>Place Order
                    </button>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Secure payment & 100% money back guarantee
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Address Modal -->
    <div class="modal fade" id="addAddressModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #2c5530, #4a7c59); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-map-marker-alt me-2"></i>Add New Address
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addressForm">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" name="phone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" name="addressLine1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address Line 2 (Optional)</label>
                            <input type="text" class="form-control" name="addressLine2">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">City</label>
                                <input type="text" class="form-control" name="city" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">State</label>
                                <input type="text" class="form-control" name="state" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">PIN Code</label>
                                <input type="text" class="form-control" name="pinCode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Landmark (Optional)</label>
                                <input type="text" class="form-control" name="landmark">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="isDefault" id="defaultAddress">
                            <label class="form-check-label" for="defaultAddress">
                                Make this my default address
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addAddress()">
                        <i class="fas fa-plus me-1"></i>Add Address
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Orders Modal -->
    <div class="modal fade" id="ordersModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #2c5530, #4a7c59); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-box me-2"></i>My Orders
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="orders-loading" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading orders...</span>
                        </div>
                    </div>
                    <div id="orders-container">
                        <!-- Orders will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentProduct = null;
        let selectedAddress = null;
        let quantity = 1;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const cropId = urlParams.get('cropId');
            
            if (!cropId) {
                showError('No product selected. Redirecting to marketplace...');
                setTimeout(() => {
                    window.location.href = '/marketplace';
                }, 2000);
                return;
            }

            loadProduct(cropId);
            loadAddresses();
            updateWishlistCount();
        });

        // Load product details
        async function loadProduct(cropId) {
            try {
                const response = await fetch(`/crops/${cropId}`);
                if (!response.ok) throw new Error('Product not found');
                
                const product = await response.json();
                currentProduct = product;
                
                // Populate product details
                document.getElementById('product-image').src = product.imageUrl || '/uploads/crop/default.jpg';
                document.getElementById('product-name').textContent = product.name || 'Product';
                document.getElementById('product-description').textContent = product.description || 'No description available';
                document.getElementById('product-price').textContent = product.price || '0';
                document.getElementById('product-rating').textContent = product.rating || '4.5';
                
                // Populate features
                const featuresContainer = document.getElementById('product-features');
                const features = product.features || ['Fresh', 'Organic', 'High Quality'];
                featuresContainer.innerHTML = features.map(feature => 
                    `<span class="feature-badge">${feature}</span>`
                ).join('');
                
                // Calculate initial total
                calculateTotal();
                
                // Show product content
                document.getElementById('product-loading').style.display = 'none';
                document.getElementById('product-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading product:', error);
                showError('Failed to load product details');
            }
        }

        // Load addresses
        async function loadAddresses() {
            try {
                const response = await fetch('/api/ecommerce/addresses', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayAddresses(data.addresses || []);
                } else {
                    console.error('Failed to load addresses');
                    displayAddresses([]);
                }
            } catch (error) {
                console.error('Error loading addresses:', error);
                displayAddresses([]);
            } finally {
                document.getElementById('addresses-loading').style.display = 'none';
            }
        }

        // Display addresses
        function displayAddresses(addresses) {
            const container = document.getElementById('addresses-container');
            
            if (addresses.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                        <p>No addresses found. Please add a delivery address.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = addresses.map(address => `
                <div class="address-card ${address.isDefault ? 'selected' : ''}" 
                     onclick="selectAddress('${address._id}', this)">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${address.fullName}</h6>
                            <p class="mb-1 text-muted">${address.addressLine1}</p>
                            ${address.addressLine2 ? `<p class="mb-1 text-muted">${address.addressLine2}</p>` : ''}
                            <p class="mb-1 text-muted">${address.city}, ${address.state} - ${address.pinCode}</p>
                            <small class="text-muted">📞 ${address.phone}</small>
                        </div>
                        <div>
                            ${address.isDefault ? '<span class="badge bg-success">Default</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Auto-select default address
            const defaultAddress = addresses.find(addr => addr.isDefault);
            if (defaultAddress) {
                selectAddress(defaultAddress._id);
            }
        }

        // Select address
        function selectAddress(addressId, element) {
            selectedAddress = addressId;
            
            // Update UI
            document.querySelectorAll('.address-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (element) {
                element.classList.add('selected');
            } else {
                const addressCard = document.querySelector(`[onclick*="${addressId}"]`);
                if (addressCard) addressCard.classList.add('selected');
            }
            
            // Enable place order button
            document.getElementById('place-order-btn').disabled = false;
        }

        // Update quantity
        function updateQuantity(change) {
            const quantityInput = document.getElementById('quantity');
            let newQuantity = parseInt(quantityInput.value) + change;
            
            if (newQuantity < 1) newQuantity = 1;
            if (newQuantity > 100) newQuantity = 100;
            
            quantityInput.value = newQuantity;
            quantity = newQuantity;
            calculateTotal();
        }

        // Calculate total
        function calculateTotal() {
            if (!currentProduct) return;
            
            const price = parseFloat(currentProduct.price) || 0;
            const qty = parseInt(document.getElementById('quantity').value) || 1;
            const subtotal = price * qty;
            
            document.getElementById('summary-price').textContent = price;
            document.getElementById('summary-quantity').textContent = qty;
            document.getElementById('summary-subtotal').textContent = subtotal;
            document.getElementById('summary-total').textContent = subtotal;
        }

        // Show add address modal
        function showAddAddressModal() {
            const modal = new bootstrap.Modal(document.getElementById('addAddressModal'));
            modal.show();
        }

        // Add address
        async function addAddress() {
            const form = document.getElementById('addressForm');
            const formData = new FormData(form);
            
            const addressData = {
                fullName: formData.get('fullName'),
                phone: formData.get('phone'),
                addressLine1: formData.get('addressLine1'),
                addressLine2: formData.get('addressLine2'),
                city: formData.get('city'),
                state: formData.get('state'),
                pinCode: formData.get('pinCode'),
                landmark: formData.get('landmark'),
                isDefault: formData.get('isDefault') === 'on'
            };
            
            try {
                const response = await fetch('/api/ecommerce/addresses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(addressData)
                });
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addAddressModal'));
                    modal.hide();
                    form.reset();
                    loadAddresses();
                    showSuccess('Address added successfully!');
                } else {
                    throw new Error('Failed to add address');
                }
            } catch (error) {
                console.error('Error adding address:', error);
                showError('Failed to add address');
            }
        }

        // Place order
        async function placeOrder() {
            if (!selectedAddress) {
                showError('Please select a delivery address');
                return;
            }
            
            if (!currentProduct) {
                showError('Product information not available');
                return;
            }
            
            const quantity = parseInt(document.getElementById('quantity').value);
            const totalAmount = parseFloat(document.getElementById('summary-total').textContent);
            
            // Store order details for success page (including address)
            localStorage.setItem('lastOrderCrop', currentProduct.name);
            localStorage.setItem('lastOrderAmount', totalAmount);
            localStorage.setItem('lastOrderQuantity', quantity);
            localStorage.setItem('lastOrderAddress', JSON.stringify(selectedAddress));
            localStorage.setItem('lastOrderProduct', JSON.stringify({
                id: currentProduct._id,
                name: currentProduct.name,
                price: currentProduct.price,
                imageUrl: currentProduct.imageUrl
            }));
            
            const orderData = {
                items: [{
                    cropId: currentProduct._id,
                    quantity: quantity,
                    price: parseFloat(currentProduct.price)
                }],
                deliveryAddress: selectedAddress,
                paymentMethod: 'cod',
                totalAmount: totalAmount
            };

            try {
                const button = document.getElementById('place-order-btn');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Placing Order...';
                
                showSuccess('Order placed successfully!');
                
                // Send order to server and handle response
                fetch('/api/ecommerce/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(orderData)
                }).then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Redirect with real order ID from server
                        setTimeout(() => {
                            window.location.href = `/order-success.html?orderId=${result.order.orderId}`;
                        }, 1000);
                    } else {
                        // Server responded but failed, use temp ID
                        const tempOrderId = 'KIS' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();
                        setTimeout(() => {
                            window.location.href = `/order-success.html?orderId=${tempOrderId}&temp=true`;
                        }, 1000);
                    }
                }).catch(error => {
                    console.log('Order submission error:', error);
                    // Network error or server down, use temp ID
                    const tempOrderId = 'KIS' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();
                    setTimeout(() => {
                        window.location.href = `/order-success.html?orderId=${tempOrderId}&temp=true`;
                    }, 1000);
                });
                
            } catch (error) {
                console.error('Error placing order:', error);
                showError('Failed to place order. Please try again.');
                
                const button = document.getElementById('place-order-btn');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Place Order';
            }
        }        // View orders
        async function viewOrders() {
            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();
            
            // Show loading
            document.getElementById('orders-loading').style.display = 'flex';
            document.getElementById('orders-container').innerHTML = '';
            
            try {
                const response = await fetch('/api/ecommerce/orders', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayOrders(data.orders || []);
                } else {
                    throw new Error('Failed to load orders');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orders-container').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Failed to load orders</p>
                    </div>
                `;
            } finally {
                document.getElementById('orders-loading').style.display = 'none';
            }
        }

        // Display orders
        function displayOrders(orders) {
            const container = document.getElementById('orders-container');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-box fa-3x mb-3"></i>
                        <p>No orders found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="mb-1">Order #${order._id.substring(0, 8)}</h6>
                                <small class="text-muted">${new Date(order.createdAt).toLocaleDateString()}</small>
                            </div>
                            <span class="badge bg-${getStatusColor(order.status)}">${order.status}</span>
                        </div>
                        
                        <div class="mb-3">
                            ${order.items.map(item => `
                                <div class="d-flex align-items-center mb-2">
                                    <img src="${item.cropId?.image || '/uploads/crop/default.jpg'}" 
                                         class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                                    <div class="ms-3">
                                        <h6 class="mb-0">${item.cropId?.name || 'Product'}</h6>
                                        <small class="text-muted">Qty: ${item.quantity} kg × ₹${item.price}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total: ₹${order.totalAmount}</strong>
                            <small class="text-muted">${order.paymentMethod.toUpperCase()}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get status color
        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'pending': return 'warning';
                case 'confirmed': return 'info';
                case 'shipped': return 'primary';
                case 'delivered': return 'success';
                case 'cancelled': return 'danger';
                default: return 'secondary';
            }
        }

        // Update wishlist count
        async function updateWishlistCount() {
            try {
                const response = await fetch('/api/ecommerce/wishlist', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.wishlist?.items?.length || 0;
                    document.getElementById('wishlist-count').textContent = count;
                }
            } catch (error) {
                console.error('Error loading wishlist count:', error);
            }
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
