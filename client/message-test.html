<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Loading Test - Kisaan Connect</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; }
        h1 { color: #333; text-align: center; }
        button { background: #4CAF50; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; font-weight: bold; }
        button:hover { background: #45a049; }
        .result { background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 6px; white-space: pre-wrap; font-family: monospace; font-size: 13px; border-left: 4px solid #ddd; }
        .success { border-left-color: #4CAF50; background: #f0fff0; }
        .error { border-left-color: #f44336; background: #fff0f0; color: #d32f2f; }
        .warning { border-left-color: #ff9800; background: #fff8e1; color: #f57c00; }
        .test-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’¬ Message Loading Diagnostic Tool</h1>
        
        <div class="test-buttons">
            <button onclick="checkSystem()">1. Check System Status</button>
            <button onclick="createTestData()">2. Create Test Data</button>
            <button onclick="testMessageAPI()">3. Test Message API</button>
            <button onclick="testFullChat()">4. Test Full Chat</button>
        </div>
        
        <div id="results" class="result">Click buttons above to run tests...</div>
        
        <div class="container">
            <h3>ðŸ”— Quick Links</h3>
            <div class="test-buttons">
                <a href="/Login.html" style="text-decoration: none;"><button>Login Page</button></a>
                <a href="/chats" style="text-decoration: none;"><button>Chat Page</button></a>
                <a href="/HomePage_DetailsFilling.html" style="text-decoration: none;"><button>Main Page</button></a>
                <a href="/api/chats/debug" style="text-decoration: none;"><button>Debug API</button></a>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const results = document.getElementById('results');
            results.textContent += message + '\n';
            results.scrollTop = results.scrollHeight;
        }

        function clearLog() {
            document.getElementById('results').textContent = '';
        }

        async function checkSystem() {
            clearLog();
            log('ðŸ” Checking system status...\n');
            
            try {
                const response = await fetch('/api/chats/debug');
                const data = await response.json();
                
                log('âœ… SYSTEM STATUS:');
                log(`ðŸ‘¥ Users: ${data.farmersCount}`);
                log(`ðŸŒ¾ Crops: ${data.cropsCount}`);
                log(`ðŸ’¬ Chats: ${data.chatsCount}`);
                log(`ðŸ“¨ Messages: ${data.messagesCount}`);
                
                if (data.sampleFarmers.length > 0) {
                    log('\nðŸ‘¤ Sample Users:');
                    data.sampleFarmers.forEach(user => {
                        log(`  â€¢ ${user.fullName} (${user.phoneNumber})`);
                    });
                }
                
                if (data.sampleChats.length > 0) {
                    log('\nðŸ’¬ Sample Chats:');
                    data.sampleChats.forEach(chat => {
                        const participants = chat.participants.map(p => p.fullName).join(' & ');
                        log(`  â€¢ Chat: ${participants}`);
                    });
                }
                
                if (data.sampleMessages.length > 0) {
                    log('\nðŸ“¨ Sample Messages:');
                    data.sampleMessages.forEach(msg => {
                        log(`  â€¢ ${msg.sender.fullName}: ${msg.content.substring(0, 50)}...`);
                    });
                }
                
                document.getElementById('results').className = 'result success';
                
            } catch (error) {
                log(`âŒ System check failed: ${error.message}`);
                document.getElementById('results').className = 'result error';
            }
        }
        
        async function createTestData() {
            clearLog();
            log('ðŸ› ï¸ Creating test data...\n');
            
            try {
                // Create test users first
                log('1. Creating test users...');
                const users = [
                    { name: 'Test Seller', phone: '9999999999' },
                    { name: 'Test Buyer', phone: '8888888888' }
                ];
                
                for (const user of users) {
                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                fullName: user.name,
                                phoneNumber: user.phone,
                                password: 'test123',
                                state: 'Karnataka',
                                district: 'Bangalore',
                                villageTown: 'Test Village',
                                pinCode: '560001'
                            })
                        });
                        
                        if (response.ok || response.status === 400) { // 400 might be "user exists"
                            log(`âœ… User ${user.name}: Ready`);
                        }
                    } catch (e) {
                        log(`âš ï¸ User ${user.name}: May already exist`);
                    }
                }
                
                // Create test messages
                log('\n2. Creating test messages...');
                const messageResponse = await fetch('/api/chats/debug/create-test-messages', {
                    method: 'POST'
                });
                
                if (messageResponse.ok) {
                    const result = await messageResponse.json();
                    log(`âœ… Messages created: ${result.messagesCreated}`);
                    log(`ðŸ’¬ Chat ID: ${result.chatId}`);
                    log(`ðŸ‘¥ Participants: ${result.participants.join(' & ')}`);
                } else {
                    const error = await messageResponse.text();
                    log(`âŒ Failed to create messages: ${error}`);
                }
                
                log('\nðŸŽ¯ Test data ready! Use login credentials:');
                log('ðŸ“± Phone: 9999999999 or 8888888888');
                log('ðŸ”‘ Password: test123');
                
                document.getElementById('results').className = 'result success';
                
            } catch (error) {
                log(`âŒ Failed to create test data: ${error.message}`);
                document.getElementById('results').className = 'result error';
            }
        }
        
        async function testMessageAPI() {
            clearLog();
            log('ðŸ§ª Testing Message API...\n');
            
            try {
                // First check authentication
                log('1. Checking authentication...');
                const authResponse = await fetch('/user');
                
                if (!authResponse.ok) {
                    log('âš ï¸ Not logged in - testing unauthenticated access...');
                    
                    // Test without auth (should fail)
                    const testResponse = await fetch('/api/chats/test123/messages');
                    log(`ðŸ“¡ Unauthenticated request: ${testResponse.status} ${testResponse.statusText}`);
                    
                    if (testResponse.status === 401) {
                        log('âœ… API properly secured (401 Unauthorized)');
                    }
                    
                    log('\nâ— To test message loading:');
                    log('1. Login at /Login.html');
                    log('2. Then run this test again');
                    
                    document.getElementById('results').className = 'result warning';
                    return;
                }
                
                const user = await authResponse.json();
                log(`âœ… Logged in as: ${user.fullName} (ID: ${user.id})`);
                
                // Get user's chats
                log('\n2. Fetching user chats...');
                const chatsResponse = await fetch('/api/chats');
                
                if (chatsResponse.ok) {
                    const chatsData = await chatsResponse.json();
                    const chats = chatsData.chats || [];
                    
                    log(`ðŸ“¬ Found ${chats.length} chats`);
                    
                    if (chats.length === 0) {
                        log('âš ï¸ No chats found. Creating test chat first...');
                        await createTestData();
                        return;
                    }
                    
                    // Test message loading for first chat
                    const firstChat = chats[0];
                    log(`\n3. Testing message loading for chat: ${firstChat.chatId}`);
                    log(`   Participant: ${firstChat.participant.name}`);
                    
                    const messagesResponse = await fetch(`/api/chats/${firstChat.chatId}/messages`);
                    
                    if (messagesResponse.ok) {
                        const messagesData = await messagesResponse.json();
                        const messages = messagesData.messages || [];
                        
                        log(`âœ… Messages loaded successfully: ${messages.length} messages`);
                        
                        if (messages.length > 0) {
                            log('\nðŸ“¨ Sample messages:');
                            messages.slice(0, 3).forEach((msg, index) => {
                                log(`   ${index + 1}. ${msg.sender.name}: ${msg.content}`);
                            });
                        } else {
                            log('âš ï¸ No messages in chat');
                        }
                        
                        document.getElementById('results').className = 'result success';
                    } else {
                        const error = await messagesResponse.text();
                        log(`âŒ Failed to load messages: ${messagesResponse.status} - ${error}`);
                        document.getElementById('results').className = 'result error';
                    }
                } else {
                    const error = await chatsResponse.text();
                    log(`âŒ Failed to load chats: ${chatsResponse.status} - ${error}`);
                    document.getElementById('results').className = 'result error';
                }
                
            } catch (error) {
                log(`âŒ API test failed: ${error.message}`);
                document.getElementById('results').className = 'result error';
            }
        }
        
        async function testFullChat() {
            clearLog();
            log('ðŸŽ¯ Full Chat System Test...\n');
            
            try {
                // Check if logged in
                const authResponse = await fetch('/user');
                if (!authResponse.ok) {
                    log('â— Please login first:');
                    log('1. Go to /Login.html');
                    log('2. Use phone: 9999999999 or 8888888888');
                    log('3. Password: test123');
                    log('4. Return here and test again');
                    document.getElementById('results').className = 'result warning';
                    return;
                }
                
                const user = await authResponse.json();
                log(`ðŸ‘¤ Testing as: ${user.fullName}`);
                
                // Test all components
                log('\nðŸ” Testing all chat components...');
                
                // 1. Chats list
                const chatsResponse = await fetch('/api/chats');
                log(`1. Chats API: ${chatsResponse.status === 200 ? 'âœ… OK' : 'âŒ FAIL'}`);
                
                if (chatsResponse.ok) {
                    const chatsData = await chatsResponse.json();
                    const chats = chatsData.chats || [];
                    
                    if (chats.length > 0) {
                        const chat = chats[0];
                        
                        // 2. Messages loading
                        const messagesResponse = await fetch(`/api/chats/${chat.chatId}/messages`);
                        log(`2. Messages API: ${messagesResponse.status === 200 ? 'âœ… OK' : 'âŒ FAIL'}`);
                        
                        if (messagesResponse.ok) {
                            const messagesData = await messagesResponse.json();
                            log(`3. Messages Count: ${messagesData.messages.length}`);
                            
                            if (messagesData.messages.length > 0) {
                                log('\nðŸŽ‰ CHAT SYSTEM FULLY WORKING!');
                                log('\nðŸ“‹ Next steps:');
                                log('1. Go to /chats to see the interface');
                                log('2. Click on a chat to open it');
                                log('3. Messages should load and display properly');
                                log('4. Try sending new messages');
                                
                                document.getElementById('results').className = 'result success';
                            } else {
                                log('\nâš ï¸ Chat exists but no messages');
                                log('Messages might not be displaying due to frontend issue');
                                document.getElementById('results').className = 'result warning';
                            }
                        }
                    } else {
                        log('âš ï¸ No chats found - create test data first');
                        document.getElementById('results').className = 'result warning';
                    }
                }
                
            } catch (error) {
                log(`âŒ Full test failed: ${error.message}`);
                document.getElementById('results').className = 'result error';
            }
        }
        
        // Auto-run system check
        window.onload = () => {
            setTimeout(checkSystem, 500);
        };
    </script>
</body>
</html>
