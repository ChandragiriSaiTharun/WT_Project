<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crops Test - Kisaan Connect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background-color: #f8f9fa; }
    .test-container { max-width: 900px; margin: 0 auto; }
    .crop-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h3><i class="fas fa-leaf"></i> Crops Database Test</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h5>Database Status</h5>
            <div id="cropsStatus" class="mb-3">
              <button class="btn btn-info" onclick="testCropsConnection()">Test Crops DB</button>
            </div>
            
            <h5>Current Crops in Database</h5>
            <div id="cropsData" class="mb-3">
              <button class="btn btn-success" onclick="loadCrops()">Load Crops</button>
            </div>
          </div>
          
          <div class="col-md-6">
            <h5>Add Test Crop</h5>
            <form id="testCropForm">
              <div class="mb-2">
                <input type="text" class="form-control form-control-sm" name="cropName" placeholder="Crop Name" value="Test Wheat" required>
              </div>
              <div class="mb-2">
                <input type="number" class="form-control form-control-sm" name="cropPrice" placeholder="Price per unit" value="50" required>
              </div>
              <div class="mb-2">
                <input type="number" class="form-control form-control-sm" name="cropQuantity" placeholder="Quantity" value="100" required>
              </div>
              <div class="mb-2">
                <select class="form-control form-control-sm" name="cropUnit" required>
                  <option value="kg">Kg</option>
                  <option value="quintal">Quintal</option>
                  <option value="ton">Ton</option>
                </select>
              </div>
              <div class="mb-2">
                <input type="text" class="form-control form-control-sm" name="sellerName" placeholder="Seller Name" value="Test Farmer" required>
              </div>
              <div class="mb-2">
                <input type="text" class="form-control form-control-sm" name="location" placeholder="Location" value="Test City" required>
              </div>
              <div class="mb-2">
                <input type="file" class="form-control form-control-sm" name="cropImage" accept="image/*">
              </div>
              <button type="submit" class="btn btn-primary btn-sm">Add Test Crop</button>
            </form>
            <div id="cropResult" class="mt-3"></div>
          </div>
        </div>
        
        <hr>
        
        <div class="mt-4">
          <h5>Frontend Crops API Test</h5>
          <button class="btn btn-warning" onclick="testFrontendCropsAPI()">Test /crops Endpoint</button>
          <div id="frontendTest" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function testCropsConnection() {
      const statusDiv = document.getElementById('cropsStatus');
      try {
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Testing crops database...';
        
        const response = await fetch('/api/test/crops');
        const data = await response.json();
        
        if (response.ok) {
          statusDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úÖ Crops Database Connected!<br>
              Total Crops: ${data.totalCrops}
            </div>
          `;
        } else {
          statusDiv.innerHTML = `
            <div class="alert alert-danger">
              ‚ùå Connection Failed: ${data.error}
            </div>
          `;
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="alert alert-danger">
            ‚ùå Network Error: ${error.message}
          </div>
        `;
      }
    }

    async function loadCrops() {
      const cropsDiv = document.getElementById('cropsData');
      try {
        cropsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Loading crops...';
        
        const response = await fetch('/api/test/crops');
        const data = await response.json();
        
        if (response.ok) {
          if (data.crops && data.crops.length > 0) {
            const cropsHtml = data.crops.map(crop => `
              <div class="crop-item">
                <strong>${crop.name}</strong> - ‚Çπ${crop.price}/${crop.unit}<br>
                üì¶ Qty: ${crop.quantity} ${crop.unit} | üë§ ${crop.seller}<br>
                üìç ${crop.location} | üïí ${new Date(crop.addedDate).toLocaleDateString()}<br>
                ${crop.image ? `üñºÔ∏è Image: ${crop.image}` : 'üì∑ No image'}
              </div>
            `).join('');
            
            cropsDiv.innerHTML = `
              <div class="alert alert-info">
                Found ${data.totalCrops} crops in database:
              </div>
              <div style="max-height: 300px; overflow-y: auto;">
                ${cropsHtml}
              </div>
            `;
          } else {
            cropsDiv.innerHTML = `
              <div class="alert alert-warning">
                ‚ö†Ô∏è No crops found in database
              </div>
            `;
          }
        } else {
          cropsDiv.innerHTML = `
            <div class="alert alert-danger">
              ‚ùå Failed to load crops: ${data.error}
            </div>
          `;
        }
      } catch (error) {
        cropsDiv.innerHTML = `
          <div class="alert alert-danger">
            ‚ùå Network Error: ${error.message}
          </div>
        `;
      }
    }

    async function testFrontendCropsAPI() {
      const testDiv = document.getElementById('frontendTest');
      try {
        testDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Testing frontend API...';
        
        const response = await fetch('/crops');
        const data = await response.json();
        
        testDiv.innerHTML = `
          <div class="card">
            <div class="card-header">Frontend API Response (/crops)</div>
            <div class="card-body">
              <strong>Status:</strong> ${response.status}<br>
              <strong>Response Structure:</strong><br>
              <pre style="font-size: 12px; max-height: 200px; overflow: auto;">${JSON.stringify(data, null, 2)}</pre>
            </div>
          </div>
        `;
      } catch (error) {
        testDiv.innerHTML = `
          <div class="alert alert-danger">
            ‚ùå API Test Error: ${error.message}
          </div>
        `;
      }
    }

    // Test crop form
    document.getElementById('testCropForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const resultDiv = document.getElementById('cropResult');
      const formData = new FormData(this);
      
      try {
        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Adding crop...';
        
        const response = await fetch('/crops', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úÖ Crop Added Successfully!<br>
              Crop ID: ${result.cropId}
            </div>
          `;
          // Refresh crops list
          loadCrops();
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              ‚ùå Failed to Add Crop: ${result.error}
            </div>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            ‚ùå Network Error: ${error.message}
          </div>
        `;
      }
    });

    // Auto-test on load
    window.onload = function() {
      testCropsConnection();
      loadCrops();
    };
  </script>
</body>
</html>
