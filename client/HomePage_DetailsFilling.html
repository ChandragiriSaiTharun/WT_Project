<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>Kisaan Connect - Marketplace</title>
    <style>
      /* Main body styles */
      body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 20px;
        position: relative;
        width: auto;
        height: 100vh;
        background: url("https://images.unsplash.com/photo-1586773860418-d37222d8fce3?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80") no-repeat center center fixed;
        background-size: cover;
      }

      #backgroundOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: -1;
        transition: opacity 0.3s ease-in-out;
      }

      /* Navbar */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 5%;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        width: 90%;
        left: 50%;
        transform: translateX(-50%);
        top: 0;
        z-index: 1000;
        box-sizing: border-box;
      }

      .menu-icon {
        font-size: 36px;
        color: #28a745;
        cursor: pointer;
      }

      header .logo {
        display: flex;
        align-items: center;
        font-size: 24px;
        font-weight: 700;
        color: #28a745;
      }

      header .logo .icon {
        margin-right: 20px;
        font-size: 38px;
        color: #007bff;
      }

      header .logo .connect {
        color: #007bff;
      }

      header nav {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      header nav a {
        text-decoration: none;
        color: #333;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      header nav a:hover {
        color: #28a745;
      }

      header .auth-buttons button {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      header .auth-buttons .register {
        background-color: #28a745;
        color: #fff;
      }

      header .auth-buttons .login {
        background-color: #f4f4f4;
        color: #333;
      }

      /* Sidebar */
      .sidebar {
        position: fixed;
        background-color: #333;
        top: 83px;
        left: -320px;
        width: 315px;
        height: calc(100vh - 60px);
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        transition: left 0.42s ease-in-out;
        display: flex;
        flex-direction: column;
        color: white;
      }

      .sidebar.active {
        left: 0;
      }

      .menu {
        display: flex;
        flex-direction: column;
        padding: 10px;
      }

      .menu a {
        text-decoration: none;
        font-size: 18px;
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        transition: background 0.3s, padding-left 0.3s;
        border-radius: 25px;
        margin: 5px 10px;
      }

      .menu a:hover {
        background: rgba(255, 255, 255, 0.2);
        padding-left: 30px;
      }

      .menu a i {
        margin-right: 15px;
      }

      /* Marketplace */
      .marketplace-header {
        text-align: center;
        margin: 100px 0 20px;
        color: white;
      }

      .marketplace-header h1 {
        color: #28a745;
      }

      .crop-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        max-width: 1600px;
        margin: 0 auto;
        padding: 10px;
      }

      .crop-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
        position: relative;
      }

      .crop-card:hover {
        transform: translateY(-5px);
      }

      .crop-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .price-tag {
        font-size: 20px;
        color: #28a745;
        font-weight: 600;
      }

      .button-group {
        display: flex;
        gap: 14px;
        justify-content: center;
        margin-top: 20px;
      }

      .buy-button, .chat-button {
        flex: 1;
        font-size: 17px;
        padding: 10px;
        border: none;
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .buy-button {
        background: #ffc107;
        color: black;
      }

      .buy-button:hover {
        background: #e0a800;
      }

      .chat-button {
        background: #28a745;
        color: white;
      }

      .chat-button:hover {
        background: #218838;
      }

      /* Crop Form */
      .crop-form-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .crop-form {
        background: white;
        padding: 20px;
        max-width: 500px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .crop-form input, .crop-form select {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #28a745;
        border-radius: 5px;
      }

      .crop-form button {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px;
        width: 100%;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 10px;
      }

      #addCropButton {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #28a745;
        color: white;
        font-size: 18px;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s;
      }

      #addCropButton:hover {
        background: #218838;
        transform: translateX(-50%) scale(1.05);
      }
    </style>
</head>
<body>
    <div id="backgroundOverlay"></div>
    <header>
        <div class="menu-icon" onclick="toggleSidebar()"><i class="material-icons">menu</i></div>
        <div class="sidebar" id="sidebar">
            <nav class="menu">
                <a href="/HomePage_DetailsFilling.html"><i class="material-icons">home</i> Home</a>
                <a href="/weather.html"><i class="material-icons">wb_sunny</i> Weather Updates</a>
                <a href="#"><i class="material-icons">bar_chart</i> Market Prices</a>
                <a href="#"><i class="material-icons">campaign</i> Government Schemes</a>
                <a href="#"><i class="material-icons">build</i> Equipment Rental</a>
                <a href="#"><i class="material-icons">local_offer</i> Discounts</a>
                <a href="#"><i class="material-icons">chat</i> My Chats</a>
                <a href="#"><i class="material-icons">help</i> Help & Support</a>
            </nav>
        </div>
        <div class="logo">
            <span class="icon">ðŸŒ¾</span>
            <span>Kisaan</span>
            <span class="connect">Connect</span>
        </div>
        <nav>
            <div class="auth-buttons">
                <a href="/registration.html"><button class="register">Register</button></a>
                <a href="/Login.html"><button class="login">Login</button></a>
                <a href="/logout"><button class="login">Logout</button></a>
            </div>
        </nav>
    </header>

    <div class="marketplace-header">
        <h1>Your Farming Marketplace</h1>
        <p>Sell and Buy Directly from Farmers</p>
    </div>

    <div class="crop-grid" id="cropGrid"></div>

    <div class="crop-form-container" id="cropFormContainer" onclick="closeForm(event)">
        <div class="crop-form" onclick="event.stopPropagation()">
            <h2>Sell Your Crop <span class="icon">ðŸŒ¾</span></h2>
            <input type="text" id="cropName" placeholder="Crop Name" required>
            <input type="file" id="cropImage" accept="image/*" required>
            <select id="cropUnit" required>
                <option value="" selected>--Select Unit--</option>
                <option value="kg">Kilogram (kg)</option>
                <option value="quintal">Quintal (100 kg)</option>
                <option value="ton">Ton (1000 kg)</option>
                <option value="pound">Pounds (lb)</option>
            </select>
            <input type="number" id="cropQuantity" placeholder="Quantity" required>
            <input type="number" id="cropPrice" placeholder="Price per Unit" required>
            <input type="text" id="sellerName" placeholder="Seller Name" required>
            <input type="text" id="sellerLocation" placeholder="Location" required>
            <button onclick="addCrop()">Add Crop</button>
        </div>
    </div>

    <button id="addCropButton" onclick="openCropForm()">+ Add Crop</button>

    <script>
        async function checkLogin() {
            try {
                const response = await fetch('/user', { credentials: 'include' });
                return response.ok;
            } catch {
                return false;
            }
        }

        function openCropForm() {
            checkLogin().then(isLoggedIn => {
                if (!isLoggedIn) {
                    if (confirm('You need to log in to add a crop. Go to login page?')) {
                        window.location.href = '/Login.html';
                    }
                } else {
                    document.getElementById('cropFormContainer').style.display = 'flex';
                    document.getElementById('addCropButton').style.visibility = 'hidden';
                }
            });
        }

        function closeForm(event) {
            if (event.target.id === "cropFormContainer") {
                document.getElementById('cropFormContainer').style.display = 'none';
                document.getElementById('addCropButton').style.visibility = 'visible';
            }
        }

        async function addCrop() {
            const name = document.getElementById('cropName').value;
            const imageInput = document.getElementById('cropImage');
            const price = document.getElementById('cropPrice').value;
            const quantity = document.getElementById('cropQuantity').value;
            const seller = document.getElementById('sellerName').value;
            const location = document.getElementById('sellerLocation').value;
            const unit = document.getElementById('cropUnit').value;

            if (!name || !imageInput.files.length || !price || !quantity || !seller || !location || !unit) {
                alert("Please fill all fields correctly!");
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('cropImage', imageInput.files[0]);
            formData.append('price', price);
            formData.append('quantity', quantity);
            formData.append('seller', seller);
            formData.append('location', location);
            formData.append('unit', unit);

            try {
                const response = await fetch('/add-crop', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                const result = await response.json();

                if (response.ok) {
                    alert('Crop added successfully!');
                    document.getElementById('cropFormContainer').style.display = 'none';
                    document.getElementById('addCropButton').style.visibility = 'visible';
                    fetchCrops(); // Refresh crop list
                } else {
                    alert(result.error || 'Failed to add crop');
                }
            } catch (error) {
                console.error('Error adding crop:', error);
                alert('Something went wrong!');
            }
        }

        async function fetchCrops() {
            try {
                const response = await fetch('/crops');
                const crops = await response.json();
                const cropGrid = document.getElementById('cropGrid');
                cropGrid.innerHTML = '';

                crops.forEach(crop => {
                    const card = document.createElement('div');
                    card.className = 'crop-card';
                    card.innerHTML = `
                        <img src="/uploads/${crop.image || 'placeholder.jpg'}" class="crop-image" alt="${crop.name}">
                        <div class="crop-details">
                            <h3>${crop.name}</h3>
                            <div class="price-tag">â‚¹${crop.price}/${crop.unit}</div>
                            <div>Available: ${crop.quantity} ${crop.unit}</div>
                            <div>Seller: ${crop.seller} - ${crop.location}</div>
                            <div class="button-group">
                                <button class="buy-button" onclick="buyCrop('${crop.id}')">Buy Now</button>
                                <button class="chat-button">Chat</button>
                            </div>
                        </div>
                    `;
                    cropGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Error fetching crops:', error);
                document.getElementById('cropGrid').innerHTML = '<p>Failed to load crops. Please try again later.</p>';
            }
        }

        async function buyCrop(cropId) {
            const isLoggedIn = await checkLogin();
            if (!isLoggedIn) {
                if (confirm('You need to log in to buy a crop. Go to login page?')) {
                    window.location.href = '/Login.html';
                }
            } else {
                alert(`Buying crop with ID: ${cropId} (Feature TBD)`);
                // Add buy logic here later
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchCrops(); // Load crops on page load
            document.addEventListener('click', (event) => {
                const sidebar = document.getElementById('sidebar');
                const menuIcon = document.querySelector('.menu-icon');
                if (sidebar.classList.contains('active') && !sidebar.contains(event.target) && event.target !== menuIcon) {
                    sidebar.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>