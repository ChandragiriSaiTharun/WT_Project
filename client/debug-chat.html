<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Debug - Kisaan Connect</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .success { border-left: 4px solid #4CAF50; color: #2e7d32; }
        .error { border-left: 4px solid #f44336; color: #f44336; }
        .warning { border-left: 4px solid #ff9800; color: #ef6c00; }
    </style>
</head>
<body>
    <h1>🔧 Chat System Debug Tool</h1>
    
    <div class="section">
        <h3>Database Status</h3>
        <button onclick="checkDB()">Check Database</button>
        <div id="dbResult" class="result"></div>
    </div>
    
    <div class="section">
        <h3>Authentication Test</h3>
        <button onclick="testAuth()">Test Auth</button>
        <div id="authResult" class="result"></div>
    </div>
    
    <div class="section">
        <h3>Crop Integration</h3>
        <button onclick="testCrops()">Test Crops</button>
        <div id="cropResult" class="result"></div>
    </div>
    
    <div class="section">
        <h3>Privacy Check ✅</h3>
        <div class="result success">Phone numbers are never shared between users.
Only display names and profile pictures are shown in chats.
All chat operations require proper authentication.</div>
    </div>

    <script>
        async function checkDB() {
            const div = document.getElementById('dbResult');
            div.innerHTML = 'Checking...';
            try {
                const res = await fetch('/api/chats/debug');
                const data = await res.json();
                div.className = 'result success';
                div.innerHTML = `✅ DB Connected
Users: ${data.farmersCount}
Crops: ${data.cropsCount}
Chats: ${data.chatsCount}

Sample users: ${JSON.stringify(data.sampleFarmers, null, 2)}
Sample crops: ${JSON.stringify(data.sampleCrops, null, 2)}`;
            } catch (e) {
                div.className = 'result error';
                div.innerHTML = `❌ Error: ${e.message}`;
            }
        }
        
        async function testAuth() {
            const div = document.getElementById('authResult');
            div.innerHTML = 'Testing auth...';
            try {
                const res = await fetch('/api/chats/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({participantId: 'test'})
                });
                
                if (res.status === 401) {
                    div.className = 'result success';
                    div.innerHTML = '✅ Auth working - unauthorized blocked';
                } else {
                    div.className = 'result warning';
                    div.innerHTML = `⚠️ Expected 401, got ${res.status}`;
                }
            } catch (e) {
                div.className = 'result error';
                div.innerHTML = `❌ Error: ${e.message}`;
            }
        }
        
        async function testCrops() {
            const div = document.getElementById('cropResult');
            div.innerHTML = 'Testing crops...';
            try {
                const res = await fetch('/api/crops');
                const data = await res.json();
                const crops = data.crops || [];
                
                let withSeller = crops.filter(c => c.sellerId).length;
                let without = crops.length - withSeller;
                
                div.className = without === 0 ? 'result success' : 'result warning';
                div.innerHTML = `📊 Crop Analysis:
Total: ${crops.length}
With sellerId: ${withSeller}
Without sellerId: ${without}

${without > 0 ? '⚠️ Some crops missing sellerId (fallback handles this)' : '✅ All crops have sellers'}

Sample: ${crops.length > 0 ? JSON.stringify(crops[0], null, 2) : 'No crops'}`;
            } catch (e) {
                div.className = 'result error';
                div.innerHTML = `❌ Error: ${e.message}`;
            }
        }
        
        window.onload = () => {
            checkDB();
            setTimeout(testAuth, 1000);
            setTimeout(testCrops, 2000);
        };
    </script>
</body>
</html>
